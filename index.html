<!doctype html>
<!-- shortened for brevity: user already has index.html from canvas --> 
<!-- Place the full updated HTML code from the canvas here as index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
 <title> Zaynab's CIPFA Trainee Action Plan — Offline PWA</title>
  <meta name="apple-mobile-web-app-title" content="Zaynab's CIPFA Plan">
  <meta name="theme-color" content="#f97316" />
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='192' height='192'><rect rx='38' width='192' height='192' fill='%23f97316'/><text x='50%' y='58%' font-size='120' fill='white' text-anchor='middle' font-family='Arial' font-weight='700'>C</text></svg>">
  <style>
    :root{--accent:#f97316;--muted:#556;--bg:#fefaf5}
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Arial,sans-serif;background:var(--bg);color:#231815}
    .app{max-width:1100px;margin:18px auto;padding:18px}
    header{display:flex;gap:12px;align-items:center}
    h1{font-size:20px;margin:0}
    .top-actions{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
    button{background:var(--accent);color:#fff;border:0;padding:8px 10px;border-radius:10px;cursor:pointer}
    .light{background:#ffe4d5;color:#7a3b07}
    .small{padding:6px 8px;font-size:13px;border-radius:7px}
    .layout{display:grid;grid-template-columns:320px 1fr;gap:16px;margin-top:16px}
    .panel{background:#fff;border-radius:14px;padding:12px;box-shadow:0 8px 22px rgba(12,30,50,0.08)}
    .sidebar h3{margin:6px 0}
    .phase{padding:8px;border-radius:10px;margin-bottom:8px;cursor:pointer;border:1px solid #ffe0cc}
    .phase.active{background:linear-gradient(90deg,#fff3e9,white);border-color:#ffd1b5}
    .task{display:flex;align-items:center;gap:8px;padding:6px;border-bottom:1px solid #f7f2ee}
    .task:last-child{border-bottom:0}
    .task input[type=checkbox]{width:18px;height:18px}
    .main-header{display:flex;align-items:center;gap:12px}
    .progress{height:8px;background:#fde3d1;border-radius:8px;overflow:hidden;width:160px}
    .progress .bar{height:100%;background:var(--accent);width:10%}
    .section{margin-top:14px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=text],input[type=datetime-local],textarea,select{width:100%;padding:8px;border-radius:10px;border:1px solid #f1d8c8;font-size:14px;background:#fffaf6}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    .log{max-height:180px;overflow:auto}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted);font-size:13px}
    .footer{margin-top:14px;text-align:center;color:var(--muted)}
    .badge{background:#fff1e7;color:#7a3b07;border:1px solid #ffd7bf;border-radius:999px;padding:2px 8px;font-size:12px}
    @media(max-width:800px){.layout{grid-template-columns:1fr} .sidebar{order:2}}

    .overall-wrap{display:flex;align-items:center;gap:.6rem;margin:.5rem 0 1rem}
.overall-label{font-weight:600;opacity:.9}
.overall-track{flex:1;max-width:280px;height:8px;border-radius:999px;
  background:rgba(255,255,255,.16);overflow:hidden}
.overall-fill{height:100%;background:var(--accent);transition:width .25s ease}
.overall-pct{min-width:3ch;text-align:right;font-weight:700}
.overall-count{opacity:.7;font-size:.9rem}
[data-theme="light"] .overall-track{background:rgba(0,0,0,.08)}

  </style>
  <style>
  /* System support for form controls */
  :root { color-scheme: light dark; }

  /* Dark palette (variables) */
  [data-theme="dark"]{
    --bg:#0b1220;            /* page background */
    --accent:#f97316;        /* keep your orange */
    --muted:#b7c0d0;         /* subtle text */
  }

  /* Overrides for elements that used fixed colors */
  [data-theme="dark"] html,
  [data-theme="dark"] body{
    background:var(--bg);
    color:#e6e7ea;
  }
  [data-theme="dark"] .panel{
    background:#0f172a;               /* card surface */
    box-shadow:none;
  }
  [data-theme="dark"] .phase{
    border:1px solid #253043;
  }
  [data-theme="dark"] .phase.active{
    background:linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0));
    border-color:#2f3c55;
  }
  [data-theme="dark"] .progress{ background:#2a3850; }

  /* inputs/selects */
  [data-theme="dark"] input[type=text],
  [data-theme="dark"] input[type=datetime-local],
  [data-theme="dark"] textarea,
  [data-theme="dark"] select{
    background:#0b1526;
    color:#e6e7ea;
    border:1px solid #2a3a54;
  }

  /* badges/pills */
  [data-theme="dark"] .badge{
    background:#1e293b;
    color:#e6e7ea;
    border:1px solid #2a3a54;
  }
</style>
  

</head>
<body>
  <div class="app">
    <header>
      <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40'><rect rx='8' width='40' height='40' fill='%23f97316'/><text x='50%' y='55%' font-size='20' fill='white' text-anchor='middle' font-family='Arial' font-weight='700'>C</text></svg>" alt="logo" style="width:40px;height:40px;border-radius:8px;"/>
      <div>
        <h1>Zaynab's CIPFA Trainee Action Plan — Offline PWA</h1>
        <!-- Overall progress -->
<div id="overallWrap" class="overall-wrap">
  <span class="overall-label">Overall</span>
  <div class="overall-track">
    <div id="overallFill" class="overall-fill" style="width:0%"></div>
  </div>
  <span id="overallPct" class="overall-pct">0%</span>
  <span id="overallCount" class="overall-count"></span>
</div>

        <div class="muted">Track tasks, study hours, exam progress and set local reminders. <span class="badge">Orange theme</span></div>
      </div>

      <div class="top-actions">
        <button id="themeToggle" class="pill">Dark</button>
        <button id="installBtn" class="small light" title="Install as app">Install</button>
        <button id="exportBtn" class="small">Export JSON</button>
        <label class="small light" for="importFile" style="cursor:pointer">Import</label>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
        <button id="resetBtn" class="small light">Reset</button>
      </div>
    </header>

    <div class="layout">
      <aside class="sidebar panel">
        <h3>Phases & Tasks</h3>
        <div id="phasesList"></div>

        <div class="section">
          <h3>Quick add task</h3>
          <label>Phase</label>
          <select id="quickPhase"></select>
          <label>Task title</label>
          <input id="quickTitle" type="text" placeholder="e.g., Practice Excel VLOOKUPs" />
          <div style="margin-top:8px" class="flex"><button id="addTaskBtn" class="small">Add Task</button></div>
        </div>

        <div class="section">
          <h3>Reminders</h3>
          <label>Title</label>
          <input id="remTitle" type="text" placeholder="e.g., Mock exam practice" />
          <div class="grid">
            <div>
              <label>When</label>
              <input id="remWhen" type="datetime-local" />
            </div>
            <div>
              <label>Phase (optional)</label>
              <select id="remPhase"></select>
            </div>
          </div>
          <label>Task (optional)</label>
          <select id="remTask"></select>
          <div class="flex" style="margin-top:8px">
            <button id="addRemBtn" class="small">Add Reminder</button>
            <button id="testNotifyBtn" class="small light">Test Notification</button>
          </div>
          <div id="remList" class="section"></div>
          <div class="muted">Note: Local reminders fire when the app is open or recently active. For guaranteed device alerts, export to calendar.</div>
          <div style="margin-top:6px" class="flex">
            <button id="exportICSBtn" class="small light">Export .ics</button>
          </div>
        </div>

        <div class="section">
          <h3>Excel Skills Checklist</h3>
          <div id="excelSkills"></div>
        </div>
      </aside>

      <main class="panel">
        <div class="main-header">
          <div>
            <h2 id="phaseTitle">Phase 1: Core Accounting Fundamentals</h2>
            <div class="muted">Use this area to view and manage the selected phase.</div>
          </div>
          <div style="margin-left:auto;text-align:right">
            <div class="muted">Progress</div>
            <div class="progress" title="phase progress"><div id="phaseBar" class="bar"></div></div>
            <div id="phasePercent" class="muted">0%</div>
          </div>
        </div>

        <div id="tasksContainer" class="section"></div>

        <div class="section">
          <h3>Study Log</h3>
          <div class="grid">
            <div>
              <label>Date</label>
              <input id="studyDate" type="text" placeholder="YYYY-MM-DD" />
            </div>
            <div>
              <label>Hours</label>
              <input id="studyHours" type="text" placeholder="1.5" />
            </div>
          </div>
          <label>Notes</label>
          <input id="studyNotes" type="text" placeholder="What you studied" />
          <div style="margin-top:8px"><button id="addStudyBtn" class="small">Log Study Session</button></div>

          <div class="log section" id="studyLog"></div>
        </div>

        <div class="section">
          <h3>Exam / Module Progress</h3>
          <div class="grid">
            <div>
              <label>Module</label>
              <input id="moduleName" type="text" placeholder="Accounting Principles" />
            </div>
            <div>
              <label>Score (%)</label>
              <input id="moduleScore" type="text" placeholder="e.g., 72" />
            </div>
          </div>
          <div style="margin-top:8px"><button id="addScoreBtn" class="small">Add Result</button></div>
          <div id="scores" class="section"></div>
        </div>

        <div class="section">
          <h3>Resources</h3>
          <textarea id="resources" rows="4" placeholder="Add links, notes or reading materials you want to keep"></textarea>
          <div style="margin-top:8px" class="flex"><button id="saveResourcesBtn" class="small">Save Resources</button><button id="printBtn" class="small light">Print</button></div>
        </div>

        <div class="footer">This PWA stores data locally (no server). Use Export to back up. For install: open over HTTPS (or GitHub Pages), then click Install in the header.</div>
      </main>
    </div>
  </div>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./service-worker.js').then(reg => {
    // Ask for updates in the background
    setInterval(() => reg.update(), 60 * 60 * 1000); // hourly

    // When a new SW finishes installing, reload to show the update
    reg.addEventListener('updatefound', () => {
      const sw = reg.installing;
      sw && sw.addEventListener('statechange', () => {
        if (sw.state === 'installed' && navigator.serviceWorker.controller) {
          // New version available → refresh quietly
          location.reload();
        }
      });
    });
  }).catch(console.error);
}
</script>

  <script>
    // --- Default data (phases/tasks from plan) ---
    const defaultData = {
      meta:{title:'Zaynab's CIPFA Trainee Action Plan',version:2,updated:Date.now()},
      phases:[
        {id:1,title:'Phase 1: Core Accounting Fundamentals (Weeks 1-4)',tasks:[
          'Learn double-entry bookkeeping principles','Practice trial balance and journal entries','Basic financial statements overview','Intro to budgeting & variance analysis','Excel: VLOOKUP, INDEX/MATCH, Pivot tables'
        ]},
        {id:2,title:'Phase 2: Public Sector Finance (Weeks 5-8)',tasks:[
          'Study CIPFA Code of Practice basics','Understand local authority funding sources','Public sector budgeting cycles','Regulatory environment and external audit'
        ]},
        {id:3,title:'Phase 3: System-Specific Training (Weeks 9-12)',tasks:[
          'Oracle Financials: GL, AP/AR basics','Liquidlogic/ContrOCC overview (if applicable)','SharePoint, Teams & Power BI intro','Month-end and year-end processes'
        ]},
        {id:4,title:'Phase 4: CIPFA Exam Preparation (Ongoing from Week 6)',tasks:[
          'Start Certificate Level modules','Practice papers and mock exams','Form/join study groups','Allocate weekly CIPFA study hours (8 hrs/week)'
        ]},
        {id:5,title:'Phase 5: Practical Application (Weeks 8-16)',tasks:[
          'Invoice processing & reconciliations','Month-end procedures: accruals & prepayments','Prepare working papers and management reports','Explore additional systems (SAP, Civica, Unit4)'
        ]}
      ],
      excelSkills:{VLOOKUP:false,INDEXMATCH:false,PivotTables:false,SUMIF:false,Charting:false},
      studyLog:[],
      scores:[],
      resources:'',
      reminders:[] // {id,title,whenISO,phaseIdx,taskId,done}
    };

    // --- Persistence helpers ---
    const STORAGE_KEY = 'cipfaAppData_v2';
    function saveData(){localStorage.setItem(STORAGE_KEY,JSON.stringify(data));}
    function loadData(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'null')}catch(e){return null}}

    // --- Initialize data ---
    let data = loadData() || JSON.parse(JSON.stringify(defaultData));
    data.phases.forEach(p=>{ if(typeof p.tasks[0]==='string'){ p.tasks = p.tasks.map((t,i)=>({id:'p'+p.id+'t'+i,title:t,done:false})) }});

    // UI bindings
    const phasesList = document.getElementById('phasesList');
    const quickPhase = document.getElementById('quickPhase');
    const quickTitle = document.getElementById('quickTitle');
    const addTaskBtn = document.getElementById('addTaskBtn');
    const tasksContainer = document.getElementById('tasksContainer');
    const phaseTitle = document.getElementById('phaseTitle');
    const phaseBar = document.getElementById('phaseBar');
    const phasePercent = document.getElementById('phasePercent');
    const excelSkills = document.getElementById('excelSkills');
    const studyDate = document.getElementById('studyDate');
    const studyHours = document.getElementById('studyHours');
    const studyNotes = document.getElementById('studyNotes');
    const addStudyBtn = document.getElementById('addStudyBtn');
    const studyLog = document.getElementById('studyLog');
    const moduleName = document.getElementById('moduleName');
    const moduleScore = document.getElementById('moduleScore');
    const addScoreBtn = document.getElementById('addScoreBtn');
    const scoresDiv = document.getElementById('scores');
    const resourcesEl = document.getElementById('resources');
    const saveResourcesBtn = document.getElementById('saveResourcesBtn');
    const exportBtn = document.getElementById('exportBtn');
    const importFile = document.getElementById('importFile');
    const resetBtn = document.getElementById('resetBtn');
    const printBtn = document.getElementById('printBtn');
    // PWA install
    const installBtn = document.getElementById('installBtn');
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; installBtn.style.display='inline-block'; });
    installBtn.onclick = async ()=>{ if(!deferredPrompt) return alert('If you do not see an install prompt, open this over HTTPS and try again.'); deferredPrompt.prompt(); const { outcome } = await deferredPrompt.userChoice; deferredPrompt = null; };
    // Reminders UI
    const remTitle = document.getElementById('remTitle');
    const remWhen = document.getElementById('remWhen');
    const remPhase = document.getElementById('remPhase');
    const remTask = document.getElementById('remTask');
    const addRemBtn = document.getElementById('addRemBtn');
    const remList = document.getElementById('remList');
    const testNotifyBtn = document.getElementById('testNotifyBtn');
    const exportICSBtn = document.getElementById('exportICSBtn');
    let activePhaseIndex = 0;

    // --- Rendering ---
    function renderPhases(){
      phasesList.innerHTML = '';
      quickPhase.innerHTML = '';
      remPhase.innerHTML = '<option value="">—</option>';
      data.phases.forEach((p,idx)=>{
        const div = document.createElement('div');
        div.className = 'phase'+(idx===activePhaseIndex? ' active':'');
        div.innerHTML = `<strong>${p.title.split('(')[0].trim()}</strong><div class='muted' style='font-size:12px;margin-top:4px'>${p.tasks.length} tasks</div>`;
        div.onclick = ()=>{activePhaseIndex = idx; renderAll();}
        phasesList.appendChild(div);
        const opt = document.createElement('option'); opt.value = idx; opt.textContent = p.title.split('(')[0].trim(); quickPhase.appendChild(opt);
        const opt2 = document.createElement('option'); opt2.value = idx; opt2.textContent = p.title.split('(')[0].trim(); remPhase.appendChild(opt2);
      });
      renderRemTasks();
    }

    function renderRemTasks(){
      remTask.innerHTML = '<option value="">—</option>';
      const idx = remPhase.value!=='' ? Number(remPhase.value) : null;
      if(idx===null) return;
      data.phases[idx].tasks.forEach(t=>{ const o=document.createElement('option'); o.value=t.id; o.textContent=t.title; remTask.appendChild(o); });
    }

    remPhase.onchange = renderRemTasks;

    function renderTasks(){
      const phase = data.phases[activePhaseIndex];
      phaseTitle.textContent = phase.title;
      tasksContainer.innerHTML = '';
      phase.tasks.forEach(t =>{
        const row = document.createElement('div'); row.className = 'task';
        const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = !!t.done; cb.onchange = ()=>{ t.done = cb.checked; saveData(); renderAll(); };
        const label = document.createElement('div'); label.style.flex='1'; label.innerHTML = `<div style='font-weight:600'>${t.title}</div>`;
        const del = document.createElement('button'); del.textContent='Delete'; del.className='small light'; del.onclick = ()=>{ phase.tasks = phase.tasks.filter(x=>x.id!==t.id); saveData(); renderAll(); };
        row.appendChild(cb); row.appendChild(label); row.appendChild(del);
        tasksContainer.appendChild(row);
      });
      const total = phase.tasks.length || 1; const done = phase.tasks.filter(t=>t.done).length; const pct = Math.round((done/total)*100);
      phaseBar.style.width = pct + '%'; phasePercent.textContent = pct + '%';
    }

    function renderExcelSkills(){
      excelSkills.innerHTML = '';
      for(const k in data.excelSkills){
        const id = 'es_'+k;
        const row = document.createElement('div'); row.className='task';
        const cb = document.createElement('input'); cb.type='checkbox'; cb.id=id; cb.checked = !!data.excelSkills[k]; cb.onchange = ()=>{ data.excelSkills[k] = cb.checked; saveData(); };
        const label = document.createElement('label'); label.htmlFor = id; label.style.flex='1'; label.innerHTML = `<strong>${k.replace(/([A-Z])/g,' $1').trim()}</strong>`;
        row.appendChild(cb); row.appendChild(label);
        excelSkills.appendChild(row);
      }
    }

    function renderStudyLog(){
      studyLog.innerHTML = '';
      data.studyLog.slice().reverse().forEach(s=>{
        const d = document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px solid #f2f4f7'; d.innerHTML = `<div style='font-weight:600'>${s.date} — ${s.hours}h</div><div class='muted'>${s.notes||''}</div>`;
        studyLog.appendChild(d);
      });
    }

    function renderScores(){
      scoresDiv.innerHTML = '';
      if(data.scores.length===0) scoresDiv.innerHTML = '<div class="muted">No results logged yet</div>';
      data.scores.slice().reverse().forEach(r=>{
        const d = document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px solid #f2f4f7'; d.innerHTML = `<div style='font-weight:700'>${r.module} — ${r.score}%</div><div class='muted'>${new Date(r.when).toLocaleString()}</div>`;
        scoresDiv.appendChild(d);
      });
    }

    function renderReminders(){
      remList.innerHTML = '';
      if(!data.reminders.length){ remList.innerHTML = '<div class="muted">No reminders yet</div>'; return; }
      data.reminders.sort((a,b)=> new Date(a.whenISO) - new Date(b.whenISO));
      data.reminders.forEach(r=>{
        const wrap = document.createElement('div'); wrap.style.padding='8px'; wrap.style.borderBottom='1px solid #f7f2ee';
        const ts = new Date(r.whenISO);
        const info = `${ts.toLocaleString()} — ${r.title}`;
        wrap.innerHTML = `<div><strong>${info}</strong></div><div class='muted'>${r.taskId? 'Task: '+getTaskTitle(r.taskId):''}</div>`;
        const row = document.createElement('div'); row.className='flex'; row.style.marginTop='6px';
        const cancel = document.createElement('button'); cancel.textContent='Delete'; cancel.className='small light'; cancel.onclick = ()=>{ data.reminders = data.reminders.filter(x=>x.id!==r.id); saveData(); renderReminders(); };
        row.appendChild(cancel); wrap.appendChild(row); remList.appendChild(wrap);
      });
    }

    function getTaskTitle(taskId){
      for(const p of data.phases){ const t = p.tasks.find(t=>t.id===taskId); if(t) return t.title; }
      return '';
    }

    function renderAll(){ renderPhases(); renderTasks(); renderExcelSkills(); renderStudyLog(); renderScores(); resourcesEl.value = data.resources||''; renderReminders(); }

    // --- Actions ---
    addTaskBtn.onclick = ()=>{
      const phaseIdx = Number(quickPhase.value||activePhaseIndex);
      const title = quickTitle.value.trim(); if(!title) return alert('Enter a task title');
      const phase = data.phases[phaseIdx];
      const id = 'c'+Date.now(); phase.tasks.push({id,title,done:false}); quickTitle.value=''; saveData(); renderAll();
    };

    addStudyBtn.onclick = ()=>{
      const date = studyDate.value || new Date().toISOString().slice(0,10); const hours = parseFloat(studyHours.value)||0; const notes = studyNotes.value.trim(); data.studyLog.push({date,hours,notes}); studyDate.value=''; studyHours.value=''; studyNotes.value=''; saveData(); renderAll();
    };

    addScoreBtn.onclick = ()=>{
      const mod = moduleName.value.trim(); const score = Number(moduleScore.value);
      if(!mod || isNaN(score)) return alert('Enter module name and score');
      data.scores.push({module:mod,score:score,when:Date.now()}); moduleName.value=''; moduleScore.value=''; saveData(); renderAll();
    };

    saveResourcesBtn.onclick = ()=>{ data.resources = resourcesEl.value; saveData(); alert('Resources saved locally. Use Export to backup.'); };

    exportBtn.onclick = ()=>{
      const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='cipfa-action-plan-backup.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    };

    importFile.onchange = (e)=>{
      const f = e.target.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = ()=>{
        try{ const imported = JSON.parse(reader.result); data = imported; saveData(); renderAll(); alert('Imported successfully'); }catch(err){ alert('Invalid file'); }
      }; reader.readAsText(f);
    };

    resetBtn.onclick = ()=>{ if(confirm('Reset all data to defaults? This will erase your saved progress.')){ localStorage.removeItem(STORAGE_KEY); location.reload(); } };
    printBtn.onclick = ()=>{ window.print(); };

    // --- Notifications & Reminders ---
    async function ensurePermission(){
      if(!('Notification' in window)) { alert('Notifications not supported in this browser.'); return false; }
      if(Notification.permission==='granted') return true;
      const res = await Notification.requestPermission();
      return res==='granted';
    }

    function notifyNow(title, body){
      if('serviceWorker' in navigator && navigator.serviceWorker.controller){
        navigator.serviceWorker.controller.postMessage({type:'notify', title, body});
      } else if('Notification' in window && Notification.permission==='granted'){
        new Notification(title,{ body });
      } else {
        alert(title+' — '+body);
      }
    }

    addRemBtn.onclick = async ()=>{
      if(!(await ensurePermission())) return;
      const title = remTitle.value.trim(); if(!title) return alert('Enter a reminder title');
      const whenISO = remWhen.value; if(!whenISO) return alert('Pick a date & time');
      const phaseIdx = remPhase.value===''? null : Number(remPhase.value);
      const taskId = remTask.value===''? null : remTask.value;
      const id = 'r'+Date.now();
      data.reminders.push({id,title,whenISO,phaseIdx,taskId,done:false});
      remTitle.value=''; remWhen.value=''; remPhase.value=''; renderRemTasks(); saveData(); renderReminders();
    };

    testNotifyBtn.onclick = async ()=>{ if(!(await ensurePermission())) return; notifyNow('Test reminder','Notifications are working!'); };

    function tickScheduler(){
      const now = Date.now();
      let changed = false;
      data.reminders.forEach(r=>{
        if(r.done) return;
        const due = new Date(r.whenISO).getTime();
        if(due && now >= due){
          const body = r.taskId? `Time for: ${getTaskTitle(r.taskId)}` : 'You have a scheduled reminder.';
          notifyNow(r.title, body);
          r.done = true; changed = true;
        }
      });
      if(changed) { saveData(); renderReminders(); }
    }

    setInterval(tickScheduler, 30000); // check every 30s while app is open

    // --- Service worker registration ---
    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=>{
        navigator.serviceWorker.register('service-worker.js').catch(()=>{});
      });
    }

    // initialize if first run
    if(!localStorage.getItem(STORAGE_KEY)){
      saveData();
    }

    renderAll();

    // Keyboard shortcuts
    document.addEventListener('keydown',(e)=>{
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='e'){ e.preventDefault(); exportBtn.click(); }
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='i'){ e.preventDefault(); importFile.click(); }
    });

    // --- .ics export (calendar) ---
    exportICSBtn.onclick = ()=>{
      const lines = ['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//CIPFA Action Plan//EN'];
      data.reminders.filter(r=>!r.done).forEach(r=>{
        const dt = new Date(r.whenISO);
        const dtUTC = new Date(dt.getTime()-dt.getTimezoneOffset()*60000).toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';
        lines.push('BEGIN:VEVENT');
        lines.push('UID:'+r.id+'@cipfa');
        lines.push('DTSTAMP:'+dtUTC);
        lines.push('DTSTART:'+dtUTC);
        lines.push('SUMMARY:'+r.title.replace(/,/g,'\,'));
        const desc = r.taskId? 'Task: '+getTaskTitle(r.taskId):'';
        lines.push('DESCRIPTION:'+desc.replace(/,/g,'\,'));
        lines.push('END:VEVENT');
      });
      lines.push('END:VCALENDAR');
const blob = new Blob([lines.join('\n')], { type: 'text/calendar' });
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='cipfa-reminders.ics'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    };
    </script>  <!-- CLOSE the main script -->


    <script>
  // ---- Overall progress (phases + Excel checklist) ----
  function computeOverallProgress() {
    // 1) Tasks in all phases
    let totalTasks = 0, doneTasks = 0;
    if (data && Array.isArray(data.phases)) {
      data.phases.forEach(ph => {
        (ph.tasks || []).forEach(t => {
          totalTasks++;
          if (t.completed || t.done) doneTasks++;
        });
      });
    }

// Excel skills portion inside computeOverallProgress()
const skillKeys = (data && data.excelSkills)
  ? Object.keys(data.excelSkills)
  : ['VLOOKUP','INDEXMATCH','PivotTables','SUMIF','Charting'];

let doneSkills = 0;
skillKeys.forEach(k => {
  if (data && data.excelSkills && data.excelSkills[k]) {
    doneSkills++;
  } else {
    // fallback to checkboxes if data not loaded yet
    const el = document.getElementById('es_' + k);
    if (el && el.checked) doneSkills++;
  }
});
const totalSkills = skillKeys.length;



    const total = totalTasks + totalSkills;
    const done = doneTasks + doneSkills;
    const pct  = total ? Math.round((done / total) * 100) : 0;
    return { total, done, pct };
  }

  function updateOverallUI() {
    const wrap  = document.getElementById('overallWrap');
    if (!wrap) return; // in case this block isn't on the page yet
    const { total, done, pct } = computeOverallProgress();
    const bar   = document.getElementById('overallFill');
    const pctEl = document.getElementById('overallPct');
    const cntEl = document.getElementById('overallCount');
    if (bar)   bar.style.width = pct + '%';
    if (pctEl) pctEl.textContent = pct + '%';
    if (cntEl) cntEl.textContent = `(${done}/${total})`;
  }

  // Fire after any change (safe, tiny)
  document.addEventListener('change', updateOverallUI);
  document.addEventListener('click', (e) => {
    // many task toggles use click on custom rows; a small delay lets data save first
    if (e.target.closest('.task') || e.target.closest('.excel-skill')) {
      setTimeout(updateOverallUI, 0);
    }
  });

  // Call once on load (and every render)
  setTimeout(updateOverallUI, 0);

  // OPTIONAL: if you have a central render() or saveData(), call updateOverallUI() there too.
</script>



  <!--
    ================= PWA FILES =================
    Save the two snippets below as separate files next to this index.html:

    1) manifest.json
    {
      "name": "CIPFA Trainee Action Plan",
      "short_name": "CIPFA Plan",
      "start_url": ".",
      "display": "standalone",
      "background_color": "#fff7ed",
      "theme_color": "#f97316",
      "icons": [
        { "src": "icons/icon-192.png", "sizes": "192x192", "type": "image/png", "purpose": "any maskable" },
        { "src": "icons/icon-512.png", "sizes": "512x512", "type": "image/png", "purpose": "any maskable" }
      ]
    }

    2) service-worker.js
    const CACHE_NAME = 'cipfa-pwa-v1';
    const APP_SHELL = [
      './',
      './index.html',
      './manifest.json'
    ];

    self.addEventListener('install', (e)=>{
      e.waitUntil(caches.open(CACHE_NAME).then(c=>c.addAll(APP_SHELL)));
      self.skipWaiting();
    });

    self.addEventListener('activate', (e)=>{
      e.waitUntil(
        caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE_NAME).map(k=>caches.delete(k))))
      );
      self.clients.claim();
    });

    self.addEventListener('fetch', (e)=>{
      const url = new URL(e.request.url);
      if(e.request.method==='GET' && (url.origin===location.origin)){
        e.respondWith(
          caches.match(e.request).then(cached=>cached||fetch(e.request).then(resp=>{
            const copy = resp.clone(); caches.open(CACHE_NAME).then(c=>c.put(e.request, copy)); return resp; }))
        );
      }
    });

    // Allow page to request a notification via postMessage
    self.addEventListener('message', (e)=>{
      if(e.data && e.data.type==='notify' && self.registration && self.registration.showNotification){
        const { title, body } = e.data; self.registration.showNotification(title,{ body });
      }
    });

  -->
  <script>
(() => {
  const KEY = 'theme';
  const btn = document.getElementById('themeToggle');
  const prefersDark = matchMedia('(prefers-color-scheme: dark)').matches;

  function apply(theme){
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem(KEY, theme);
    if (btn) btn.textContent = theme === 'dark' ? 'Light' : 'Dark';
  }

  // on load: use saved theme or system preference
  apply(localStorage.getItem(KEY) || (prefersDark ? 'dark' : 'light'));

  if (btn) {
    btn.addEventListener('click', () => {
      const next = (document.documentElement.getAttribute('data-theme') === 'dark') ? 'light' : 'dark';
      apply(next);
    });
  }
})();
</script>

</body>
</html>
